@using Microsoft.AspNetCore.Identity
@inject SignInManager<User> SignInManager
@inject UserManager<User> UserManager
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>VietClean</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <meta content="" name="keywords">
    <meta content="" name="description">

    <!-- Google Web Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;600&family=Raleway:wght@600;800&display=swap" rel="stylesheet">

    <!-- Icon Font Stylesheet -->
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Libraries Stylesheet -->
    <link href="~/customer/lib/lightbox/css/lightbox.min.css" rel="stylesheet">
    <link href="~/customer/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

    <!-- Customized Bootstrap Stylesheet -->
    <link href="~/customer/css/bootstrap.min.css" rel="stylesheet">

    <!-- Template Stylesheet -->
    <link href="~/customer/css/style.css" rel="stylesheet">
    <style>
        .text-crop {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            /* Number of lines you want to display */
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>



</head>

<body>

    <!-- Spinner với backdrop blur -->
    <div id="spinner" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center bg-white bg-opacity-75" style="backdrop-filter: blur(8px); z-index: 9999;">
        <div class="spinner-grow text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Header -->
    <header class="header-section">
        <!-- Top Bar -->
        <div class="bg-primary py-2 d-none d-lg-block">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-lg-6">
                        <div class="d-flex text-white small">
                            <div class="me-4">
                                <i class="fas fa-map-marker-alt me-2 opacity-75"></i>
                                <a href="#" class="text-white text-decoration-none">Ninh Kiều, Cần Thơ</a>
                            </div>
                            <div>
                                <i class="fas fa-envelope me-2 opacity-75"></i>
                                <a href="mailto:vothanhly632002@gmail.com" class="text-white text-decoration-none">vothanhly632002@gmail.com</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6 text-end">
                        <div class="text-white small">
                            <a href="#" class="text-white text-decoration-none">Điều khoản sử dụng</a>
                            <span class="mx-2">/</span>
                            <a href="#" class="text-white text-decoration-none">Bán hàng và hoàn tiền</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top py-3">
            <div class="container">
                <!-- Logo -->
                <a class="navbar-brand" asp-controller="Home" asp-action="index">
                    <h1 class="text-primary m-0 fw-bold"><i class="fa fa-broom"></i>VNClean</h1>
                </a>

                <!-- Mobile Toggle -->
                <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Navigation Items -->
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav mx-auto">
                        <li class="nav-item">
                            <a id="TrangChu" class="nav-link" asp-controller="Home" asp-action="index">Trang chủ</a>
                        </li>
                        <li class="nav-item">
                            <a id="CuaHang" class="nav-link" asp-controller="Shop" asp-action="index">Cửa hàng</a>
                        </li>
                    </ul>

                    <!-- Right Navigation Items -->
                    <div class="d-flex align-items-center gap-3">
                        <!-- Search Button -->
                        <button class="btn btn-outline-primary rounded-circle p-2" data-bs-toggle="modal" data-bs-target="#searchModal">
                            <i class="fas fa-search"></i>
                        </button>

                        <!-- Cart -->
                        <a asp-controller="ShoppingCart" asp-action="Index" class="btn btn-outline-primary position-relative rounded-circle p-2">
                            <i class="fa fa-shopping-bag"></i>
                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                                @* số lượng sản phẩm ----------------------------------------------------------------------------------------------------------------------------------------------------- *@
                                <span class="visually-hidden">items in cart</span>
                            </span>
                        </a>

                        <!-- User Menu -->
                        <div class="dropdown">
                            <button class="btn btn-outline-primary rounded-circle p-2" type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-user"></i>
                            </button>
                            @if (SignInManager.IsSignedIn(User))
                            {
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                    <li><a class="dropdown-item" asp-area="Identity" asp-page="/Account/Manage/Index">Cài đặt tài khoản</a></li>
                                    @if (User.IsInRole("Admin"))
                                    {
                                        <li><a class="dropdown-item" asp-controller="Products" asp-action="Index">Quản trị viên</a></li>
                                    }
                                    @if (User.IsInRole(Sell__cleaning_services_e_commerce.Areas.Other.RoleList.Shipper))
                                    {
                                        <li><a class="dropdown-item" asp-controller="Shipper" asp-action="Shipper_Index">Nhân viên giao hàng</a></li>
                                    }
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Action("Index", "Home", new { area = "" })">
                                            <button type="submit" class="dropdown-item text-danger">Đăng xuất</button>
                                        </form>
                                    </li>
                                </ul>
                            }
                            else
                            {
                                <ul class="dropdown-menu dropdown-menu-end shadow border-0">
                                    <li><a class="dropdown-item" asp-area="Identity" asp-page="/Account/Register">Đăng ký</a></li>
                                    <li><a class="dropdown-item" asp-area="Identity" asp-page="/Account/Login">Đăng nhập</a></li>
                                </ul>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <!-- Search Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title">Tìm kiếm sản phẩm</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-flex align-items-center justify-content-center">
                    <div class="input-group" style="max-width: 600px;">
                        <input type="search" class="form-control form-control-lg" placeholder="Nhập từ khóa tìm kiếm..." name="SearchString">
                        <button class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    @RenderBody()

    <!-- Footer Start -->
    <div class="container-fluid bg-dark text-white-50 footer pt-5 mt-5">
        <div class="container py-5">
            <div class="pb-4 mb-4" style="border-bottom: 1px solid rgba(226, 175, 24, 0.5);">
                <div class="row g-4">
                    <div class="col-lg-3">
                        <a href="#">
                            <h1 class="text-primary mb-0">VNClean</h1>

                        </a>
                    </div>

                    <div class="col-lg-3">
                        <div class="d-flex justify-content-end pt-3">
                            <a class="btn btn-outline-secondary me-2 btn-md-square rounded-circle" href="">
                                <i class="fab fa-twitter"></i>
                            </a>
                            <a class="btn btn-outline-secondary me-2 btn-md-square rounded-circle" href="">
                                <i class="fab fa-facebook-f"></i>
                            </a>
                            <a class="btn btn-outline-secondary me-2 btn-md-square rounded-circle" href="">
                                <i class="fab fa-youtube"></i>
                            </a>
                            <a class="btn btn-outline-secondary btn-md-square rounded-circle" href="">
                                <i class="fab fa-linkedin-in"></i>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-5">
                <div class="col-lg-3 col-md-6">
                    <div class="footer-item">
                        <h4 class="text-light mb-3">Tại sao khách hàng tin tưởng chúng tôi!</h4>
                        <p class="mb-4">
                            Chúng tôi cung cấp các dụng cụ vệ sinh chất lượng cao, đảm bảo vệ sinh an toàn
                            và hiệu quả cho mọi môi trường. Với đội ngũ hỗ trợ nhiệt tình và sản phẩm uy tín, chúng tôi
                            luôn mang đến sự hài lòng cho khách hàng.
                        </p>
                        <a href="" class="btn border-secondary py-2 px-4 rounded-pill text-primary">Tìm Hiểu Thêm</a>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="d-flex flex-column text-start footer-item">
                        <h4 class="text-light mb-3">Thông Tin Cửa Hàng</h4>
                        <a class="btn-link" href="">Về Chúng Tôi</a>
                        <a class="btn-link" href="">Liên Hệ</a>
                        <a class="btn-link" href="">Chính Sách Bảo Mật</a>
                        <a class="btn-link" href="">Điều Khoản & Điều Kiện</a>
                        <a class="btn-link" href="">Chính Sách Đổi Trả</a>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="d-flex flex-column text-start footer-item">
                        <h4 class="text-light mb-3">Tài Khoản</h4>
                        <a class="btn-link" href="">Tài Khoản Của Tôi</a>
                        <a class="btn-link" href="">Chi Tiết Cửa Hàng</a>
                        <a class="btn-link" href="">Giỏ Hàng</a>
                        <a class="btn-link" href="">Danh Sách Yêu Thích</a>
                        <a class="btn-link" href="">Lịch Sử Đơn Hàng</a>
                    </div>
                </div>

                <div class="col-lg-3 col-md-6">
                    <div class="footer-item">
                        <h4 class="text-light mb-3">Liên Hệ</h4>
                        <p>Địa chỉ: Ninh Kiều, Cần Thơ</p>
                        <p>Email: vothanhly632002@gmail.com</p>
                        <p>Điện thoại: +0123 4567 8910</p>
                        <p>Chấp Nhận Thanh Toán</p>
                        <img src="img/payment.png" class="img-fluid" alt="">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer End -->
    <!-- Copyright Start -->
    <div class="container-fluid copyright bg-dark py-4">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-center text-md-start mb-3 mb-md-0">
                    <span class="text-light">
                        <a href="#"><i class="fas fa-copyright text-light me-2"></i>VNClean</a>,
                        Sản phẩm báo cáo Niên luận cơ sở.
                    </span>
                </div>

            </div>
        </div>
    </div>
    <!-- Copyright End -->
    <!-- Back to Top -->
    <a href="#" class="btn btn-primary border-3 border-primary rounded-circle back-to-top">
        <i class="fa fa-arrow-up"></i>
    </a>


    <!-- JavaScript Libraries -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/customer/lib/easing/easing.min.js"></script>
    <script src="~/customer/lib/waypoints/waypoints.min.js"></script>
    <script src="~/customer/lib/lightbox/js/lightbox.min.js"></script>
    <script src="~/customer/lib/owlcarousel/owl.carousel.min.js"></script>

    <!-- Template Javascript -->
    <script src="~/customer/js/main.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        $(document).ready(function () {
            $('.add-to-cart').on('click', function (e) {
                e.preventDefault();
                var productContainer = $(this).closest('[data-product-id]');
                var productId = productContainer.data('product-id');
                var quantity = productContainer.find('.quantity').val() || 1;

                if (!productId) {
                    alert('Không thể xác định sản phẩm. Vui lòng thử lại.');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("AddToCart", "ShoppingCart")',
                    type: 'POST',
                    data: {
                        productId: productId,
                        quantity: quantity
                    },
                    success: function (response) {
                        if (response.success) {
                            alert(response.message || 'Đã thêm sản phẩm vào giỏ hàng!');
                        } else {
                            alert(response.message || 'Có lỗi xảy ra khi thêm sản phẩm vào giỏ hàng.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX:', status, error);
                        alert('Có lỗi xảy ra khi kết nối với server. Vui lòng thử lại sau.');
                    }
                });
            });
        });



        $(document).ready(function () {
            $('.quantity-input').on('change', function () {
                var $row = $(this).closest('tr');
                var productId = $row.data('product-id');
                var quantity = $(this).val();
                var price = parseFloat($(this).data('price'));
                var total = quantity * price;

                // Cập nhật tổng giá trên giao diện
                $row.find('.item-total').text(total.toFixed(2) + ' VNĐ');

                // Gửi AJAX request để cập nhật giỏ hàng
                $.ajax({
                    url: '@Url.Action("UpdateCartItem", "ShoppingCart")',
                    type: 'POST',
                    data: {
                        productId: productId,
                        quantity: quantity
                    },
                    success: function (response) {
                        if (response.success) {
                            console.log('Cập nhật giỏ hàng thành công');
                            // Cập nhật tổng giá của toàn bộ giỏ hàng
                            updateTotalPrice();
                        } else {
                            console.error('Lỗi khi cập nhật giỏ hàng:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX:', error);
                    }
                });
            });

            // Xử lý sự kiện xóa sản phẩm
            $('.remove-item').on('click', function () {
                var $row = $(this).closest('tr');
                var productId = $row.data('product-id');

                $.ajax({
                    url: '@Url.Action("RemoveFromCart", "ShoppingCart")',
                    type: 'POST',
                    data: { productId: productId },
                    success: function (response) {
                        if (response.success) {
                            $row.remove(); // Xóa dòng khỏi bảng
                            updateTotalPrice(); // Cập nhật tổng giá
                            console.log('Đã xóa sản phẩm khỏi giỏ hàng');
                        } else {
                            console.error('Lỗi khi xóa sản phẩm:', response.message);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Lỗi AJAX:', error);
                    }
                });
            });


            // function updateTotalPrice() {
            //     var total = 0;
            //     $('.item-total').each(function () {
            //         total += parseFloat($(this).text());
            //     });
            //     $('#cart-total').text(total.toFixed(2) + ' VNĐ');
            // }


            function updateTotalPrice() {
                var total = 0;
                $('.item-total').each(function () {
                    total += parseFloat($(this).text().replace(' VNĐ', '').trim());
                });
                $('#cart-total').text(total.toFixed(2) + ' VNĐ');
            }

        });

    </script>
</body>
</html>
